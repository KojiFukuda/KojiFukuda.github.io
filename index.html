<!DOCTYPE html>
<head>
    <meta charset="utf-8">
    <title>CodeReadSample</title>
</head>
<body>
    <p><font size="6">Création</font>  データ入力モックアップ</p>
    <br />
    <lebel>入力コード : <input type="text" id="textcode" value="" ;"/></lebel><br />
    <br />
    <input type="button" id = "btn" value="Clear" onclick="OnButtonClick();"/><br />
    <br />
    <div id="output"></div>
    <div id="output2"></div>
</body>

<script>
    window.onload = initializeProc
     document.onkeydown = keyDown;
     var reading = false;
     var count = 0;
     var params = {};
     
     // 入力必須のキー
     var keys = ['userid', 'procid', 'orderno'];

     //ページ中どこでキー押されてもフォーカスはテキストボックスに
     function keyDown()
     {
        if(reading)return;
        // まずクリア
        targetinput = document.getElementById("textcode");
        targetinput.value = "";
        reading = true;
         
        count++;//デバッグ用読み取り回数
 
        // 入力ボックスにフォーカス
        targetinput.focus();
 
        // ちょっと遅延して入力確定
        sleepfunc(3000, function () {
            var inputcode = targetinput.value;
            
            var type = gettype(inputcode);
            if(type != "") params[type] = inputcode;

            target = document.getElementById("output");
            target2 = document.getElementById("output2");
            
            var body = "";
            for(let index in keys){
                var key = keys[index];
                var val = params[key] ? params[key] : "";
                body += "<lebel>"+ key + " : <input type=\"text\" readonly=\"readonly\" value=\""+val +"\" ;\"/></lebel><br />";
            }

            target.innerHTML = body;
            reading=false;
            if(isComplete()){
                target2.innerHTML= "Data is complete! </br>Send Data!</br><br>"+body;
                clearValues();
            }else{
                target2.innerHTML="";
            }

            var button = document.getElementById("btn");
            button.focus();
         });    
     }
     function isComplete(){
         var enablekey = keys.filter(key => !params[key] || params[key]=="");
         
         return enablekey.length == 0;
     }
     function gettype(readcode)
     {
        if(readcode.startsWith('EID'))return "userid";
        if(readcode.startsWith('process'))return "procid";
        if(Number(readcode) && readcode.length == 11)return "orderno";

        return "";
     }
     function clearValues()
     {
        targetinput.value = "";
        target = document.getElementById("output");
        params = {};
        target.innerHTML = "" ;
     }
     function sleepfunc(waitmilliSec, callbackFunc) {
        // 経過時間（ms）
        var spanedMSec = 0;
        var interval = 20;

        var id = setInterval(function () {
            spanedMSec+=interval;

            // 経過時間 >= 待機時間の場合、待機終了。
            if (spanedMSec >= waitmilliSec) {
                // タイマー停止
                clearInterval(id);  
                // 完了時、コールバック関数を実行
                if (callbackFunc) callbackFunc();
            }
        }, interval);
     }
 
     function initializeProc()
     {
        
 
     }
     function OnButtonClick() 
     {
       clearValues();
     }
 </script>
</html>
