<!DOCTYPE html>
<head>
    <meta charset="utf-8">
    <title>CodeReadSample</title>
</head>
<body>
    <p><font size="6">Création</font>  データ入力モックアップ</p>
    <br />
    <lebel>入力コード : <input type="text" id="textcode" value="" ;"/></lebel><br />
    <br />
    <input type="button" id = "btn" value="Clear" onclick="OnButtonClick();"/><br />
    <br />
    <div id="output"></div>
    <div id="output2"></div>
    <br/>
    <div id="output2">release @ 2022/10/18 15:35</div>
</body>

<script>
    window.onload = initializeProc
     document.onkeydown = keyDown;
     var reading = false;
     var count = 0;
     var params = {};
     
     // 入力必須のキー
     var keys = ['userid', 'procid', 'orderno'];

     //ページ中どこでキー押されてもフォーカスはテキストボックスに
     function keyDown()
     {
        if(reading)return;
        // まずクリア
        targetinput = document.getElementById("textcode");
        targetinput.value = "";
        reading = true;
         
        count++;//デバッグ用読み取り回数
 
        // 入力ボックスにフォーカス
        targetinput.focus();
 
        // ちょっと遅延して入力確定
        sleepfunc(300, function () {
            try{
                var inputcode = targetinput.value;
                var type = gettype(inputcode);
                if(type == "") return;

                params[type] = inputcode;

                target = document.getElementById("output");
                target2 = document.getElementById("output2");

                var body = "";
                for(let index in keys){
                    var key = keys[index];
                    var val = params[key] ? params[key] : "";
                    body += "<lebel>"+ key + " : <input type=\"text\" readonly=\"readonly\" value=\""+val +"\" ;\"/></lebel><br />";
                }

                target.innerHTML = body;
                if(isComplete()){
                    target2.innerHTML= "Data is complete! </br>Send Data!</br><br>"+body;
                    clearValues();
                }else{
                    target2.innerHTML="";
                }

            } finally
            {
                var button = document.getElementById("btn");
                button.focus();
                reading=false;
            }

         });    
     }
    
    //定義されたキー項目がすべて入力完了したか？
    function isComplete(){
         var enablekey = keys.filter(key => !params[key] || params[key]=="");
         return enablekey.length == 0;
    }

    // 入力値からデータ種別を推定する
    function gettype(readcode)
    {
        if(readcode.startsWith('EID'))return "userid";
        if(readcode.startsWith('process'))return "procid";
        if(Number(readcode) && readcode.length == 10)return "orderno";

        return "";
    }
    
     function clearValues()
    {
        targetinput.value = "";
        target = document.getElementById("output");
        params = {};
        target.innerHTML = "" ;
    }

    //一定時間後に指定処理を実行する
    function sleepfunc(waitmilliSec, callbackFunc) {
        var spanedMSec = 0;
        var interval = 20;

        var id = setInterval(function () {
            spanedMSec+=interval;
            if (spanedMSec >= waitmilliSec) {
                // タイマー停止＋コールバック関数実行
                clearInterval(id);  
                if (callbackFunc) callbackFunc();
            }
        }, interval);
    }
 
    function initializeProc()
    {
 
    }
    function OnButtonClick() 
    {
        clearValues();
    }
</script>
</html>
